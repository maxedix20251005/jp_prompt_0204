<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.todo.mapper.TodoMapper">

  <select id="selectPage" resultType="com.example.todo.entity.Todo">
    SELECT id, author, title, description, due_date, priority, completed, created_at, updated_at, version
    FROM todos
    ORDER BY ${sortColumn} ${sortDir}
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countAll" resultType="long">
    SELECT COUNT(*) FROM todos
  </select>

  <select id="selectOverduePage" resultType="com.example.todo.entity.Todo">
    SELECT id, author, title, description, due_date, priority, completed, created_at, updated_at, version
    FROM todos
    WHERE due_date IS NOT NULL AND due_date <![CDATA[<=]]> #{date}
    ORDER BY ${sortColumn} ${sortDir}
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="countOverdue" resultType="long">
    SELECT COUNT(*)
    FROM todos
    WHERE due_date IS NOT NULL AND due_date <![CDATA[<=]]> #{date}
  </select>

  <select id="selectOverdue" parameterType="java.time.LocalDate" resultType="com.example.todo.entity.Todo">
    SELECT id, author, title, description, due_date, priority, completed, created_at, updated_at, version
    FROM todos
    WHERE due_date IS NOT NULL AND due_date <![CDATA[<=]]> #{date}
    ORDER BY due_date ASC, priority DESC
  </select>

  <delete id="deleteByIds">
    DELETE FROM todos
    WHERE id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>

</mapper>
