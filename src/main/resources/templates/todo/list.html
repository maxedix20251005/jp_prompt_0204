<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Todo List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous" />
    <link href="/css/app.css?v=20260206" rel="stylesheet" />
</head>
<body class="app-page">
<header class="app-header">
    <div class="container app-container py-3 d-flex align-items-center justify-content-between">
        <h1 class="app-title">
            <span class="app-logo" aria-hidden="true"></span>
            TO DO LIST
        </h1>
        <div class="app-actions">
            <a class="btn btn-outline-secondary" th:href="@{/todos/export}">CSVダウンロード</a>
            <a class="btn btn-outline-secondary"
               th:if="${overdueMode}"
               th:href="@{/todos(${queryParams},page=0,size=${pageSize},sort=${sort},dir=${dir})}">一覧</a>
            <a class="btn btn-outline-secondary"
               th:if="${!overdueMode}"
               th:href="@{/todos/overdue(${queryParams},page=0,size=${pageSize},sort=${sort},dir=${dir})}">期限切れ</a>
            <a class="btn btn-primary" th:href="@{/todos/new}">+ 新規作成</a>
            <form th:action="@{/logout}" method="post" class="d-inline">
                <button type="submit" class="btn btn-outline-secondary">ログアウト</button>
            </form>
        </div>
    </div>
</header>

<main class="container app-container app-section">
    <div class="alert alert-success alert-dismissible fade show" role="alert"
         th:if="${successMessage}" th:text="${successMessage}">
        登録が完了しました
    </div>
    <div class="alert alert-danger alert-dismissible fade show" role="alert"
         th:if="${errorMessage}" th:text="${errorMessage}">
        エラーが発生しました
    </div>

    <div class="app-card">
        <div class="app-card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
                <h2 class="app-list-title mb-0 text-center flex-grow-1">TO DO Item 一覧</h2>
                <form method="get" th:action="${overdueMode} ? @{/todos/overdue} : @{/todos}">
                    <input type="hidden" name="page" value="0" />
                    <input type="hidden" name="sort" th:if="${sort}" th:value="${sort}" />
                    <input type="hidden" name="dir" th:if="${dir}" th:value="${dir}" />
                    <input type="hidden" th:each="entry : ${queryParams}" th:name="${entry.key}" th:value="${entry.value}" />
                    <div class="input-group input-group-sm">
                        <label class="input-group-text" for="size">表示件数</label>
                        <select class="form-select" id="size" name="size" onchange="this.form.submit()">
                            <option value="5" th:selected="${pageSize == 5}">5</option>
                            <option value="10" th:selected="${pageSize == 10}">10</option>
                            <option value="20" th:selected="${pageSize == 20}">20</option>
                            <option value="50" th:selected="${pageSize == 50}">50</option>
                        </select>
                    </div>
                </form>
            </div>

            <p class="text-muted mb-3" th:if="${totalElements != null}">
                全<span th:text="${totalElements}">0</span>件中
                <span th:text="${rangeStart}">0</span>-<span th:text="${rangeEnd}">0</span>件を表示
            </p>

            <form id="bulkDeleteForm" th:action="@{/todos/bulk-delete}" method="post"
                  onsubmit="return confirm('本当に削除しますか？');">
                <div class="d-flex justify-content-end mb-2">
                    <button type="submit" id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm" disabled>
                        選択した項目を削除
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped align-middle mb-0">
                    <thead>
                    <tr>
                        <th scope="col" class="text-center">
                            <input type="checkbox" id="selectAll" />
                        </th>
                        <th scope="col" class="text-center app-col-title">
                            <a class="text-decoration-none text-body app-sort-link"
                               th:classappend="${sort == 'title'} ? (dir == 'asc' ? 'app-sort-asc app-sort-active' : 'app-sort-desc app-sort-active') : ''"
                               th:href="${overdueMode} ? @{/todos/overdue(${queryParams},sort='title',dir=${(sort=='title' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})} : @{/todos(${queryParams},sort='title',dir=${(sort=='title' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})}">
                                タイトル
                            </a>
                        </th>
                        <th scope="col" class="text-center app-col-desc">説明</th>
                        <th scope="col" class="text-center app-col-due">
                            <a class="text-decoration-none text-body app-sort-link"
                               th:classappend="${sort == 'dueDate'} ? (dir == 'asc' ? 'app-sort-asc app-sort-active' : 'app-sort-desc app-sort-active') : ''"
                               th:href="${overdueMode} ? @{/todos/overdue(${queryParams},sort='dueDate',dir=${(sort=='dueDate' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})} : @{/todos(${queryParams},sort='dueDate',dir=${(sort=='dueDate' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})}">
                                期限日
                            </a>
                        </th>
                        <th scope="col" class="text-center app-col-priority">
                            <a class="text-decoration-none text-body app-sort-link"
                               th:classappend="${sort == 'priority'} ? (dir == 'asc' ? 'app-sort-asc app-sort-active' : 'app-sort-desc app-sort-active') : ''"
                               th:href="${overdueMode} ? @{/todos/overdue(${queryParams},sort='priority',dir=${(sort=='priority' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})} : @{/todos(${queryParams},sort='priority',dir=${(sort=='priority' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})}">
                                優先度
                            </a>
                        </th>
                        <th scope="col" class="text-center app-col-author">
                            <a class="text-decoration-none text-body app-sort-link"
                               th:classappend="${sort == 'author'} ? (dir == 'asc' ? 'app-sort-asc app-sort-active' : 'app-sort-desc app-sort-active') : ''"
                               th:href="${overdueMode} ? @{/todos/overdue(${queryParams},sort='author',dir=${(sort=='author' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})} : @{/todos(${queryParams},sort='author',dir=${(sort=='author' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})}">
                                作成者
                            </a>
                        </th>
                        <th scope="col" class="text-center app-col-status">
                            <a class="text-decoration-none text-body app-sort-link"
                               th:classappend="${sort == 'completed'} ? (dir == 'asc' ? 'app-sort-asc app-sort-active' : 'app-sort-desc app-sort-active') : ''"
                               th:href="${overdueMode} ? @{/todos/overdue(${queryParams},sort='completed',dir=${(sort=='completed' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})} : @{/todos(${queryParams},sort='completed',dir=${(sort=='completed' and dir=='asc') ? 'desc' : 'asc'},page=0,size=${pageSize})}">
                                完了
                            </a>
                        </th>
                        <th scope="col" class="text-center app-col-actions-head">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="todo : ${todos}"
                        th:attr="data-id=${todo.id}"
                        th:classappend="${todo.overdue} ? 'overdue-row' : (${todo.nearDeadline} ? 'warning-row' : '')">
                        <td class="text-center">
                            <input type="checkbox" name="ids" class="todo-select" th:value="${todo.id}" />
                        </td>
                        <td>
                            <span class="todo-title"
                                  th:text="${todo.title}"
                                  th:classappend="${todo.completed} ? 'completed' : ''">サンプルToDo</span>
                        </td>
                        <td th:text="${todo.description}">説明</td>
                        <td>
                            <span th:text="${#temporals.format(todo.dueDate, 'yyyy/MM/dd')}"
                                  th:classappend="${todo.dueDate != null and todo.dueDate.isBefore(T(java.time.LocalDate).now())} ? 'text-danger' : ''">
                                2026/02/04
                            </span>
                        </td>
                        <td>
                            <span th:text="${#strings.repeat('★', todo.priority != null ? todo.priority : 0)}">★★★</span>
                        </td>
                        <td th:text="${todo.author}">作成者</td>
                        <td>
                            <span class="todo-completed text-success" th:if="${todo.completed}">✔</span>
                            <span class="todo-completed text-muted" th:unless="${todo.completed}">—</span>
                        </td>
                        <td class="text-end text-nowrap app-col-actions-cell">
                            <a class="btn btn-outline-secondary btn-sm" th:href="@{/todos/{id}(id=${todo.id})}">詳細</a>
                            <a class="btn btn-outline-primary btn-sm" th:href="@{/todos/{id}/edit(id=${todo.id})}">編集</a>
                            <span class="app-table-actions">
                                <form th:action="@{/todos/{id}/toggle(id=${todo.id})}" method="post"
                                      class="d-inline todo-toggle-form" data-ajax="true">
                                    <button class="btn btn-outline-success btn-sm" type="submit">切替</button>
                                </form>
                                <form th:action="@{/todos/{id}/delete(id=${todo.id})}" method="post" class="d-inline"
                                      onsubmit="return confirm('本当に削除しますか？');">
                                    <button class="btn btn-outline-danger btn-sm" type="submit">削除</button>
                                </form>
                            </span>
                        </td>
                    </tr>
                    </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>

    <nav class="mt-3" th:if="${totalPages != null and totalPages > 1}">
        <ul class="pagination justify-content-center mb-0">
            <li class="page-item" th:classappend="${page.first} ? 'disabled'">
                <a class="page-link"
                   th:href="${overdueMode} ? @{/todos/overdue(${queryParams},page=${currentPage-1},size=${pageSize},sort=${sort},dir=${dir})} : @{/todos(${queryParams},page=${currentPage-1},size=${pageSize},sort=${sort},dir=${dir})}">
                    前へ
                </a>
            </li>
            <li class="page-item"
                th:each="i : ${#numbers.sequence(0, totalPages-1)}"
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link"
                   th:href="${overdueMode} ? @{/todos/overdue(${queryParams},page=${i},size=${pageSize},sort=${sort},dir=${dir})} : @{/todos(${queryParams},page=${i},size=${pageSize},sort=${sort},dir=${dir})}"
                   th:text="${i + 1}">
                    1
                </a>
            </li>
            <li class="page-item" th:classappend="${page.last} ? 'disabled'">
                <a class="page-link"
                   th:href="${overdueMode} ? @{/todos/overdue(${queryParams},page=${currentPage+1},size=${pageSize},sort=${sort},dir=${dir})} : @{/todos(${queryParams},page=${currentPage+1},size=${pageSize},sort=${sort},dir=${dir})}">
                    次へ
                </a>
            </li>
        </ul>
    </nav>
</main>

<footer class="app-footer">
    <div class="container app-container py-3 text-muted small">
        Todo App
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script>
    setTimeout(function () {
        document.querySelectorAll('.alert').forEach(function (alert) {
            alert.classList.remove('show');
            alert.classList.add('hide');
        });
    }, 3000);
</script>
<script>
    document.querySelectorAll('.todo-toggle-form[data-ajax="true"]').forEach(function (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            fetch(form.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function (res) {
                if (!res.ok) {
                    throw new Error('toggle failed');
                }
                return res.json();
            }).then(function (data) {
                var row = form.closest('tr');
                var title = row.querySelector('.todo-title');
                var status = row.querySelector('.todo-completed');
                if (data.completed) {
                    title.classList.add('text-decoration-line-through');
                    status.classList.remove('text-muted');
                    status.classList.add('text-success');
                    status.textContent = '✔';
                } else {
                    title.classList.remove('text-decoration-line-through');
                    status.classList.remove('text-success');
                    status.classList.add('text-muted');
                    status.textContent = '—';
                }
            }).catch(function () {
                alert('更新に失敗しました');
            });
        });
    });
</script>
<script>
    (function () {
        var selectAll = document.getElementById('selectAll');
        var bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        if (!selectAll) {
            return;
        }
        var checkboxes = document.querySelectorAll('.todo-select');

        function updateSelectAll() {
            var allChecked = true;
            var anyChecked = false;
            checkboxes.forEach(function (cb) {
                if (!cb.checked) {
                    allChecked = false;
                } else {
                    anyChecked = true;
                }
            });
            selectAll.checked = allChecked && checkboxes.length > 0;
            if (bulkDeleteBtn) {
                bulkDeleteBtn.disabled = !anyChecked;
            }
        }

        selectAll.addEventListener('change', function () {
            checkboxes.forEach(function (cb) {
                cb.checked = selectAll.checked;
            });
        });

        checkboxes.forEach(function (cb) {
            cb.addEventListener('change', updateSelectAll);
        });

        updateSelectAll();
    })();
</script>
</body>
</html>
