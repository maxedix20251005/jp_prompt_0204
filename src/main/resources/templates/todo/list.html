<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Todo List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous" />
</head>
<body class="bg-light">
<header class="border-bottom bg-white">
    <div class="container py-3 d-flex align-items-center justify-content-between">
        <h1 class="h4 mb-0">ToDo</h1>
        <a class="btn btn-primary" th:href="@{/todos/new}">+ 新規作成</a>
    </div>
</header>

<main class="container py-4">
    <div class="alert alert-success alert-dismissible fade show" role="alert"
         th:if="${successMessage}" th:text="${successMessage}">
        ToDoを削除しました
    </div>
    <div class="alert alert-danger alert-dismissible fade show" role="alert"
         th:if="${errorMessage}" th:text="${errorMessage}">
        削除に失敗しました
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="h5 mb-3">一覧</h2>
            <div class="table-responsive">
                <table class="table table-striped align-middle mb-0">
                    <thead>
                    <tr>
                        <th scope="col">タイトル</th>
                        <th scope="col">説明</th>
                        <th scope="col">期限日</th>
                        <th scope="col">優先度</th>
                        <th scope="col">作成者</th>
                        <th scope="col">完了</th>
                        <th scope="col" class="text-end">操作</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="todo : ${todos}" th:attr="data-id=${todo.id}">
                        <td>
                            <span class="todo-title"
                                  th:text="${todo.title}"
                                  th:classappend="${todo.completed} ? 'text-decoration-line-through' : ''">サンプルToDo</span>
                        </td>
                        <td th:text="${todo.description}">説明</td>
                        <td>
                            <span th:text="${#temporals.format(todo.dueDate, 'yyyy/MM/dd')}"
                                  th:classappend="${todo.dueDate != null and todo.dueDate.isBefore(T(java.time.LocalDate).now())} ? 'text-danger' : ''">
                                2026/02/04
                            </span>
                        </td>
                        <td>
                            <span th:text="${#strings.repeat('★', todo.priority != null ? todo.priority : 0)}">★★★</span>
                        </td>
                        <td th:text="${todo.author}">作成者</td>
                        <td>
                            <span class="todo-completed text-success" th:if="${todo.completed}">✔</span>
                            <span class="todo-completed text-muted" th:unless="${todo.completed}">—</span>
                        </td>
                        <td class="text-end">
                            <a class="btn btn-outline-secondary btn-sm" th:href="@{/todos/{id}(id=${todo.id})}">詳細</a>
                            <a class="btn btn-outline-primary btn-sm" th:href="@{/todos/{id}/edit(id=${todo.id})}">編集</a>
                            <form th:action="@{/todos/{id}/toggle(id=${todo.id})}" method="post"
                                  class="d-inline todo-toggle-form" data-ajax="true">
                                <button class="btn btn-outline-success btn-sm" type="submit">切替</button>
                            </form>
                            <form th:action="@{/todos/{id}/delete(id=${todo.id})}" method="post" class="d-inline"
                                  onsubmit="return confirm('本当に削除しますか？');">
                                <button class="btn btn-outline-danger btn-sm" type="submit">削除</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<footer class="border-top bg-white">
    <div class="container py-3 text-muted small">
        Todo App
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script>
    setTimeout(function () {
        document.querySelectorAll('.alert').forEach(function (alert) {
            alert.classList.remove('show');
            alert.classList.add('hide');
        });
    }, 3000);
</script>
<script>
    document.querySelectorAll('.todo-toggle-form[data-ajax="true"]').forEach(function (form) {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            fetch(form.action, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            }).then(function (res) {
                if (!res.ok) {
                    throw new Error('toggle failed');
                }
                return res.json();
            }).then(function (data) {
                var row = form.closest('tr');
                var title = row.querySelector('.todo-title');
                var status = row.querySelector('.todo-completed');
                if (data.completed) {
                    title.classList.add('text-decoration-line-through');
                    status.classList.remove('text-muted');
                    status.classList.add('text-success');
                    status.textContent = '✔';
                } else {
                    title.classList.remove('text-decoration-line-through');
                    status.classList.remove('text-success');
                    status.classList.add('text-muted');
                    status.textContent = '—';
                }
            }).catch(function () {
                alert('更新に失敗しました');
            });
        });
    });
</script>
</body>
</html>
